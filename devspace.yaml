version: v2beta1
name: kserve

pipelines:
  dev:
    run: |-
      run_dependencies --all
      ensure_pull_secrets --all
      create_deployments --all
      start_dev app
  deploy:
    run: |-
      run_dependencies --all
      ensure_pull_secrets --all
      build_images --all -t $(git describe --always)
      create_deployments --all
  # debug pipeline removed - use: devspace dev -p debug

images:
  app:
    image: quay.io/vedantm/kserve-controller:latest-0.0.1
    dockerfile: ./Containerfile

# deployments:
#   app:
#     kubectl:
#       manifests:
#         - ../config/manager
#       kustomize: true

dev:
  app:
    workingDir: /app
    labelSelector:
      control-plane: kserve-controller-manager
    container: manager
    devImage: quay.io/jostrandquay/kserve-dev:latest
    env:
      - name: GOCACHE
        value: /tmp/.cache/go-build
      - name: GOMODCACHE
        value: /tmp/.cache/go-mod
      - name: GOFLAGS
        value: -buildvcs=false
    persistPaths:
      - path: /tmp/.cache
    sync:
      - path: ../:/app
        excludePaths:
          - bin/
          - .git/
          - .devspace/
          - vendor/
          - python/
          - "*.out"
    terminal:
      command: .vscode/scripts/devspace_start.sh
    ssh:
      enabled: true
    ports:
      - port: "2345"
    resources:
      requests:
        cpu: "1.5"
        memory: 2Gi
      limits:
        cpu: "2.5"
        memory: 4Gi
    patches:
      - op: replace
        path: spec.securityContext.runAsNonRoot
        value: false
      - op: replace
        path: spec.containers[0].securityContext.runAsNonRoot
        value: false
      - op: replace
        path: spec.containers[0].securityContext.readOnlyRootFilesystem
        value: false

commands:
  debug:
    description: "Start dev container with delve debugger auto-running on :2345"
    command: devspace dev -p debug

profiles:
  - name: debug
    patches:
      - op: replace
        path: dev.app.terminal.command
        value: .vscode/scripts/devspace_debug.sh
  # - name: go1.22
  #   patches: # Use patches to modify the base configuration
  #     - op: replace
  #       path: dev.app.devImage
  #       value: quay.io/vedantm/golang:1.22-odh-kserve-debug
