version: v2beta1
name: kserve

pipelines:
  dev:
    run: |-
      run_dependencies --all
      ensure_pull_secrets --all
      create_deployments --all
      start_dev app
  deploy:
    run: |-
      run_dependencies --all
      ensure_pull_secrets --all
      build_images --all -t $(git describe --always)
      create_deployments --all

images:
  app:
    image: quay.io/vedantm/kserve-controller:latest-0.0.1
    dockerfile: ./Containerfile

dev:
  app:
    workingDir: /app
    labelSelector:
      control-plane: kserve-controller-manager
    container: manager
    devImage: quay.io/jostrandquay/kserve-dev:latest
    env:
      - name: GOCACHE
        value: /tmp/go-cache/build
      - name: GOMODCACHE
        value: /tmp/go-cache/mod
      - name: GOFLAGS
        value: -buildvcs=false
    # No persistPaths - Go cache lives in container memory
    # Survives dlv restarts, cleared on container restart (acceptable tradeoff)
    sync:
      - path: ../:/app
        excludePaths:
          # Large directories not needed for Go controller build
          - .git/
          - .github/
          - .cursor/
          - .devspace/
          - .vscode/
          - bin/
          - charts/
          - docs/
          - install/
          - python/
          - qpext/
          - test/
          - tools/
          - vendor/
          - "*.out"
    terminal:
      # Simple shell - dlv is started via kubectl exec from devspace_relaunch.sh
      command: /bin/sh -c "echo 'Devspace ready. dlv will be started externally.'; exec sleep infinity"
    ssh:
      enabled: true
    ports:
      - port: "2345"
    resources:
      requests:
        cpu: "1.5"
        memory: 2Gi
      limits:
        cpu: "2.5"
        memory: 4Gi
    patches:
      - op: replace
        path: spec.securityContext.runAsNonRoot
        value: false
      - op: replace
        path: spec.containers[0].securityContext.runAsNonRoot
        value: false
      - op: replace
        path: spec.containers[0].securityContext.readOnlyRootFilesystem
        value: false
