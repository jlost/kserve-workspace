{
    "version": "2.0.0",
    "tasks": [
        // ============================================================
        // KIND / UPSTREAM (warning background - yellow)
        // ============================================================
        {
            "label": "Kind Refresh",
            "detail": "Destroys existing cluster; use to reset to clean state",
            "type": "shell",
            "command": "${workspaceFolder}/.vscode/scripts/kind-refresh.sh",
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "server-environment",
                "color": "terminal.ansiBlack"
            },
            "options": {
                "statusbar": {
                    "label": "kind",
                    "backgroundColor": "statusBarItem.warningBackground",
                    "color": "terminal.ansiBlack",
                    "running": {
                        "color": "terminal.ansiBlue"
                    }
                }
            }
        },
        {
            "label": "Install KServe Dependencies",
            "detail": "Run after Kind Refresh; installs cert-manager and serving layer",
            "type": "shell",
            "command": "${workspaceFolder}/hack/quick_install.sh -d ${input:deploymentMode} ${input:installKeda}",
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "package",
                "color": "terminal.ansiBlue"
            },
            "options": {
                "statusbar": {
                    "label": "deps",
                    "backgroundColor": "statusBarItem.warningBackground",
                    "color": "terminal.ansiBlue",
                    "running": {
                        "color": "terminal.ansiBlack"
                    }
                }
            }
        },
        {
            "label": "Install Network Dependencies",
            "detail": "Required for ingress; run before deploying KServe",
            "type": "shell",
            "command": "${workspaceFolder}/.vscode/scripts/install-network-deps.sh ${input:networkLayer}",
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "globe",
                "color": "terminal.ansiMagenta"
            },
            "options": {
                "statusbar": {
                    "label": "network",
                    "backgroundColor": "statusBarItem.warningBackground",
                    "color": "terminal.ansiMagenta",
                    "running": {
                        "color": "terminal.ansiBlack"
                    }
                }
            }
        },
        {
            "label": "Clean Deploy KServe",
            "detail": "Rebuilds and deploys controller from local source code",
            "type": "shell",
            "command": "make undeploy-dev; make deploy-dev",
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "rocket",
                "color": "terminal.ansiGreen"
            },
            "options": {
                "cwd": "${workspaceFolder}",
                "env": {
                    "GATEWAY_NETWORK_LAYER": "${input:gatewayNetworkLayer}"
                },
                "statusbar": {
                    "label": "deploy",
                    "backgroundColor": "statusBarItem.warningBackground",
                    "color": "terminal.ansiGreen",
                    "running": {
                        "color": "terminal.ansiBlack"
                    }
                }
            }
        },
        {
            "label": "Patch Deployment Mode",
            "detail": "Updates inferenceservice-config; auto-detects if not specified",
            "type": "shell",
            "command": "MODE='${input:deploymentModeOverride}'; if [ -z \"$MODE\" ]; then if kubectl get knativeserving knative-serving -n knative-serving &>/dev/null; then MODE=Knative; else MODE=Standard; fi; echo \"Auto-detected mode: $MODE\"; else echo \"Using specified mode: $MODE\"; fi; kubectl patch configmap inferenceservice-config -n kserve --type=merge -p \"{\\\"data\\\":{\\\"deploy\\\":\\\"{\\\\\\\"defaultDeploymentMode\\\\\\\": \\\\\\\"$MODE\\\\\\\"}\\\"}}\"",
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "settings-gear",
                "color": "terminal.ansiYellow"
            },
            "options": {
                "statusbar": {
                    "label": "mode",
                    "backgroundColor": "statusBarItem.warningBackground",
                    "color": "terminal.ansiYellow"
                }
            }
        },
        {
            "label": "Recreate E2E ns (upstream)",
            "detail": "Clears test artifacts from kserve-ci-e2e-test namespace",
            "type": "shell",
            "command": "kubectl delete namespace kserve-ci-e2e-test --ignore-not-found && kubectl create namespace kserve-ci-e2e-test",
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "refresh",
                "color": "terminal.ansiCyan"
            },
            "options": {
                "statusbar": {
                    "label": "e2e ns",
                    "backgroundColor": "statusBarItem.warningBackground",
                    "color": "terminal.ansiCyan",
                    "hide": true
                }
            }
        },
        {
            "label": "Setup E2E + Port Forward (Kind)",
            "detail": "Enables inference at localhost:8080; runs in background",
            "type": "shell",
            "command": "kubectl create namespace kserve-ci-e2e-test --dry-run=client -o yaml | kubectl apply -f - && kubectl port-forward -n istio-system svc/istio-ingressgateway 8080:80",
            "isBackground": true,
            "problemMatcher": {
                "pattern": {
                    "regexp": "^$"
                },
                "background": {
                    "activeOnStart": true,
                    "beginsPattern": "^namespace/",
                    "endsPattern": "^Forwarding from"
                }
            },
            "presentation": {
                "reveal": "always",
                "panel": "dedicated",
                "close": false
            },
            "icon": {
                "id": "play",
                "color": "terminal.ansiGreen"
            },
            "options": {
                "statusbar": {
                    "label": "e2e+fwd",
                    "backgroundColor": "statusBarItem.warningBackground",
                    "color": "terminal.ansiGreen",
                    "hide": true,
                    "running": {
                        "color": "terminal.ansiBlack"
                    }
                }
            }
        },
        // ============================================================
        // OPENSHIFT (error background - red)
        // ============================================================
        {
            "label": "CRC Refresh",
            "detail": "Starts VM if stopped; may prompt for pull secret",
            "type": "shell",
            "command": "${workspaceFolder}/.vscode/scripts/crc-refresh.sh",
            "args": [],
            "isBackground": false,
            "problemMatcher": {
                "pattern": {
                    "regexp": "^$"
                },
                "background": {
                    "activeOnStart": true,
                    "beginsPattern": ".",
                    "endsPattern": "^Ready!$"
                }
            },
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "focus": true,
                "close": false
            },
            "icon": {
                "id": "vm",
                "color": "terminal.ansiWhite"
            },
            "options": {
                "cwd": "${workspaceFolder}/.vscode/scripts",
                "statusbar": {
                    "label": "crc",
                    "backgroundColor": "statusBarItem.errorBackground",
                    "color": "terminal.ansiWhite",
                    "running": {
                        "color": "terminal.ansiYellow"
                    }
                },
                "mcp": {
                    "interactive": true
                }
            }
        },
        {
            "label": "Pull Secret",
            "detail": "Enables pulling images from private registries",
            "type": "shell",
            "command": "${workspaceFolder}/.vscode/scripts/pull_secret.sh",
            "args": [],
            "isBackground": false,
            "problemMatcher": {
                "pattern": {
                    "regexp": "^$"
                },
                "background": {
                    "activeOnStart": true,
                    "beginsPattern": ".",
                    "endsPattern": "^--- Success ---$"
                }
            },
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "key",
                "color": "terminal.ansiYellow"
            },
            "options": {
                "cwd": "${workspaceFolder}/.vscode/scripts",
                "statusbar": {
                    "label": "pull secret",
                    "backgroundColor": "statusBarItem.errorBackground",
                    "color": "terminal.ansiYellow",
                    "running": {
                        "color": "terminal.ansiWhite"
                    }
                }
            }
        },
        {
            "label": "Install ODH/RHOAI Operator",
            "detail": "Installs operator via subscription; run DSCI+DSC next",
            "type": "shell",
            "command": "${workspaceFolder}/.vscode/scripts/install-odh-operator.sh",
            "args": [
                "${input:operatorType}",
                "${input:operatorVersion}"
            ],
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "cloud-download",
                "color": "terminal.ansiWhite"
            },
            "options": {
                "statusbar": {
                    "label": "operator",
                    "backgroundColor": "statusBarItem.errorBackground",
                    "color": "terminal.ansiWhite",
                    "running": {
                        "color": "terminal.ansiYellow"
                    }
                }
            }
        },
        {
            "label": "Apply DSCI + DSC",
            "detail": "Triggers operator to deploy KServe and dependencies",
            "type": "shell",
            "command": "${workspaceFolder}/.vscode/scripts/apply-dsci-dsc.sh",
            "args": [
                "${input:enableKueue}"
            ],
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "server-process",
                "color": "terminal.ansiCyan"
            },
            "options": {
                "statusbar": {
                    "label": "dsci+dsc",
                    "backgroundColor": "statusBarItem.errorBackground",
                    "color": "terminal.ansiCyan",
                    "running": {
                        "color": "terminal.ansiYellow"
                    }
                }
            }
        },
        {
            "label": "Setup E2E",
            "detail": "Creates secrets, service accounts, and test fixtures",
            "type": "shell",
            "command": "${workspaceFolder}/test/scripts/openshift-ci/setup-e2e-tests.sh",
            "args": [
                "${input:marker}"
            ],
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "gear",
                "color": "terminal.ansiWhite"
            },
            "options": {
                "statusbar": {
                    "label": "e2e setup",
                    "backgroundColor": "statusBarItem.errorBackground",
                    "color": "terminal.ansiWhite",
                    "running": {
                        "color": "terminal.ansiYellow"
                    }
                }
            }
        },
        {
            "label": "Recreate E2E ns",
            "detail": "Clears test artifacts; uses marker-specific namespace",
            "type": "shell",
            "command": "${workspaceFolder}/test/scripts/openshift-ci/setup-ci-namespace.sh ${input:marker} || ${workspaceFolder}/.vscode/scripts/refresh-e2e-ns-odh.sh",
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "refresh",
                "color": "terminal.ansiCyan"
            },
            "options": {
                "statusbar": {
                    "label": "e2e ns",
                    "backgroundColor": "statusBarItem.errorBackground",
                    "color": "terminal.ansiCyan",
                    "running": {
                        "color": "terminal.ansiYellow"
                    }
                }
            },
            "isBackground": false
        },
        {
            "label": "Teardown E2E",
            "detail": "Reverses Setup E2E; removes controllers, namespace, and KEDA",
            "type": "shell",
            "command": "${workspaceFolder}/test/scripts/openshift-ci/teardown-e2e-setup.sh",
            "args": [
                "${input:marker}"
            ],
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "trash",
                "color": "terminal.ansiYellow"
            },
            "options": {
                "statusbar": {
                    "label": "e2e teardown",
                    "backgroundColor": "statusBarItem.errorBackground",
                    "color": "terminal.ansiYellow",
                    "hide": true
                }
            }
        },
        {
            "label": "Open OpenShift Console",
            "detail": "Uses $BROWSER or defaults to brave-browser",
            "type": "shell",
            "command": "${BROWSER:-brave-browser} $(oc whoami --show-console)",
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "globe",
                "color": "terminal.ansiWhite"
            },
            "options": {
                "statusbar": {
                    "label": "console",
                    "backgroundColor": "statusBarItem.errorBackground",
                    "color": "terminal.ansiWhite"
                }
            }
        },
        {
            "label": "Fix ODH Dashboard Route (CRC)",
            "detail": "Workaround for missing route in openshift-ingress",
            "type": "shell",
            "command": "oc create route passthrough data-science-gateway --service=data-science-gateway-data-science-gateway-class --port=443 --hostname=data-science-gateway.apps-crc.testing -n openshift-ingress",
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "shared",
                "close": false
            },
            "icon": {
                "id": "plug",
                "color": "terminal.ansiYellow"
            },
            "options": {
                "statusbar": {
                    "label": "fix route",
                    "backgroundColor": "statusBarItem.errorBackground",
                    "color": "terminal.ansiYellow",
                    "hide": true, // I believe this has been fixed in the operator
                }
            }
        },
        // ============================================================
        // DEVELOPMENT (green - platform agnostic)
        // ============================================================
        {
            "label": "Devspace Dev",
            "detail": "Hot-reloads on code changes; syncs files to pod",
            "type": "shell",
            "command": "devspace dev --namespace ${input:kserveNamespace} --kube-context ${input:devspaceKubecontext} --profile interactive",
            "isBackground": true,
            "problemMatcher": {
                "pattern": {
                    "regexp": "^$"
                },
                "background": {
                    "activeOnStart": true,
                    "beginsPattern": ".",
                    "endsPattern": "devspace \\./app"
                }
            },
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "coffee",
                "color": "terminal.ansiGreen",
            },
            "options": {
                "cwd": "${workspaceFolder}/.vscode",
                "statusbar": {
                    "label": "devspace",
                    "color": "terminal.ansiGreen",
                    "running": {
                        "color": "#006600"
                    },
                    // "hide": true // superceded by devspace debug - hide for now
                },
                "mcp": {
                    "interactive": true
                }
            }
        },
        {
            "label": "Devspace Debug",
            "detail": "Idempotent: reuses existing devspace session, (re)starts dlv on :2345",
            "type": "shell",
            "command": "${workspaceFolder}/.vscode/scripts/devspace_relaunch.sh",
            "args": [
                "${input:kserveNamespace}",
                "${input:devspaceKubecontext}"
            ],
            "isBackground": true,
            "problemMatcher": {
                "pattern": {
                    "regexp": "^$"
                },
                "background": {
                    "activeOnStart": true,
                    "beginsPattern": ".",
                    "endsPattern": "API server listening at"
                }
            },
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "bug",
                "color": "terminal.ansiRed",
            },
            "options": {
                "cwd": "${workspaceFolder}/.vscode",
                "statusbar": {
                    "label": "devspace dbg",
                    "color": "terminal.ansiRed",
                    "running": {
                        "color": "#660000"
                    },
                    "hide": true // auto executed by launch config - hide for now
                }
            }
        },
        {
            "label": "Create HF Token Secret + SA",
            "detail": "Required for gated models; uses $HF_TOKEN env var",
            "type": "shell",
            "command": "${workspaceFolder}/.vscode/scripts/create-hf-secret.sh",
            "args": [
                "${input:hfNamespace}"
            ],
            "problemMatcher": [],
            "presentation": {
                "reveal": "always",
                "panel": "new",
                "close": false
            },
            "icon": {
                "id": "key",
                "color": "terminal.ansiMagenta"
            },
            "options": {
                "env": {
                    "HF_TOKEN": "${env:HF_TOKEN}"
                },
                "statusbar": {
                    "label": "hf secret",
                    "color": "terminal.ansiMagenta"
                }
            }
        },
        {
            "label": "Setup Dev Environment",
            "detail": "Runs on folder open; creates .venv with test dependencies",
            "type": "shell",
            "command": "${workspaceFolder}/.vscode/scripts/setup-dev-env.sh",
            "args": [
                // "--force"
            ],
            "runOptions": {
                "runOn": "folderOpen"
            },
            "problemMatcher": [],
            "presentation": {
                "reveal": "silent",
                "panel": "shared",
                "close": true
            },
            "icon": {
                "id": "package",
                "color": "terminal.ansiBlue"
            },
            "options": {
                "statusbar": {
                    "label": "setup py",
                    "color": "terminal.ansiBlue",
                    "running": {
                        "color": "terminal.ansiYellow"
                    },
                    "hide": true
                }
            }
        },
        {
            "label": "Watch Resource Status",
            "detail": "Live stream with color-coded status transitions",
            "type": "shell",
            "command": "${workspaceFolder}/.vscode/scripts/watch-status.sh",
            "args": [
                "${input:watchKind}",
                "${input:watchNamespace}"
            ],
            "isBackground": true,
            "runOptions": {
                "instanceLimit": 10
            },
            "problemMatcher": {
                "pattern": {
                    "regexp": "^$"
                },
                "background": {
                    "activeOnStart": true,
                    "beginsPattern": ".",
                    "endsPattern": "^$"
                }
            },
            "presentation": {
                "reveal": "always",
                "panel": "dedicated",
                "close": false
            },
            "icon": {
                "id": "eye",
                "color": "terminal.ansiCyan"
            },
            "options": {
                "statusbar": {
                    "label": "watch",
                    "color": "terminal.ansiCyan",
                    "running": {
                        "color": "#008B8B"
                    }
                }
            }
        },
        {
            "label": "Watch KServe Controller Logs",
            "detail": "Streams all containers from controller deployment",
            "type": "shell",
            "command": "kubectl logs -f -n ${input:kserveNamespace} deployment/kserve-controller-manager --all-containers",
            "isBackground": true,
            "problemMatcher": {
                "pattern": {
                    "regexp": "^$"
                },
                "background": {
                    "activeOnStart": true,
                    "beginsPattern": ".",
                    "endsPattern": "^$"
                }
            },
            "presentation": {
                "reveal": "always",
                "panel": "dedicated",
                "close": false
            },
            "icon": {
                "id": "output",
                "color": "terminal.ansiYellow"
            },
            "options": {
                "statusbar": {
                    "label": "logs",
                    "color": "terminal.ansiYellow",
                    "running": {
                        "color": "#B8860B"
                    }
                }
            }
        }
    ],
    "inputs": [
        {
            "id": "kserveNamespace",
            "type": "pickString",
            "description": "KServe controller namespace",
            "options": [
                "kserve",
                "opendatahub",
                "redhat-ods-applications"
            ],
            "default": "kserve"
        },
        {
            "id": "devspaceKubecontext",
            "type": "promptString",
            "description": "Kubecontext for devspace dev - eg. crc-admin, kind-kind",
            "default": "crc-admin"
        },
        {
            "id": "marker",
            "type": "pickString",
            "description": "Pytest marker",
            "options": [
                "predictor",
                "kserve_on_openshift",
                "graph",
                "path_based_routing",
                "batcher",
                "explainer",
                "transformer",
                ""
            ],
            "default": "predictor"
        },
        {
            "id": "operatorType",
            "type": "pickString",
            "description": "Select operator to install",
            "options": [
                "odh",
                "rhods"
            ],
            "default": "odh"
        },
        {
            "id": "operatorVersion",
            "type": "promptString",
            "description": "Operator version e.g. 3.2.0, 3.0.0 (use 2.x for v2 channels)",
            "default": "3.2.0"
        },
        {
            "id": "hfNamespace",
            "type": "promptString",
            "description": "Namespace for HuggingFace secret and service account (leave empty for current namespace)",
            "default": ""
        },
        {
            "id": "watchKind",
            "type": "pickString",
            "description": "Kubernetes resource kind to watch",
            "options": [
                "deployments",
                "pods",
                "inferenceservices",
                "services",
                "replicasets",
                "statefulsets"
            ],
            "default": "deployments"
        },
        {
            "id": "watchNamespace",
            "type": "promptString",
            "description": "Namespace to watch resources in",
            "default": "kserve-ci-e2e-test"
        },
        {
            "id": "deploymentMode",
            "type": "pickString",
            "description": "Deployment mode for KServe",
            "options": [
                {
                    "label": "Knative (serverless)",
                    "value": "-s"
                },
                {
                    "label": "Standard (raw deployment)",
                    "value": "-r"
                }
            ],
            "default": "-s"
        },
        {
            "id": "installKeda",
            "type": "pickString",
            "description": "Install KEDA for autoscaling?",
            "options": [
                {
                    "label": "No",
                    "value": ""
                },
                {
                    "label": "Yes",
                    "value": "-k"
                }
            ],
            "default": ""
        },
        {
            "id": "deploymentModeOverride",
            "type": "pickString",
            "description": "Deployment mode (leave empty to auto-detect based on Knative availability)",
            "options": [
                {
                    "label": "Auto-detect",
                    "value": ""
                },
                {
                    "label": "Knative (serverless)",
                    "value": "Knative"
                },
                {
                    "label": "Standard (raw deployment)",
                    "value": "Standard"
                }
            ],
            "default": ""
        },
        {
            "id": "enableKueue",
            "type": "pickString",
            "description": "Enable Kueue component in DSC?",
            "options": [
                {
                    "label": "No",
                    "value": "false"
                },
                {
                    "label": "Yes",
                    "value": "true"
                }
            ],
            "default": "false"
        },
        {
            "id": "networkLayer",
            "type": "pickString",
            "description": "Network layer for ingress (used when installing dependencies)",
            "options": [
                {
                    "label": "Istio Ingress (default)",
                    "value": "istio"
                },
                {
                    "label": "Istio + Gateway API",
                    "value": "istio-gatewayapi"
                },
                {
                    "label": "Envoy + Gateway API",
                    "value": "envoy-gatewayapi"
                }
            ],
            "default": "istio"
        },
        {
            "id": "gatewayNetworkLayer",
            "type": "pickString",
            "description": "Gateway network layer for KServe config (match your dependency installation)",
            "options": [
                {
                    "label": "None (Istio Ingress)",
                    "value": "false"
                },
                {
                    "label": "Istio Gateway API",
                    "value": "istio"
                },
                {
                    "label": "Envoy Gateway API",
                    "value": "envoy"
                }
            ],
            "default": "false"
        }
    ]
}